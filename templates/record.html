{% extends "base.html" %}

{% block title %}

{% endblock %}

{% block main %}
<h1>Project Summarize Record Section</h1>
<button id="start-button" class="btn btn-primary">Start Recording</button>
<button id="stop-button" class="btn btn-primary" disabled>Stop Recording</button>
<audio id="audio-player" style="display:none;"></audio>

<div id="spinner" class="text-center" style="display: none;">
  <div class="spinner-border text-primary" role="status"></div>
  <p>Processing...</p>
</div>

<div id="chat-box" class="chat-box container border rounded p-3 my-3"></div>

<script>
  let mediaRecorder;
  let audioChunks = [];

  const startButton = document.getElementById("start-button");
  const stopButton = document.getElementById("stop-button");
  const player = document.getElementById("audio-player");
  const chatBox = document.getElementById("chat-box");
  const spinner = document.getElementById("spinner");

  // Starts the recording
  startButton.onclick = async () => {
    // Ask to use the microphone
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    // Listens to live audio and records it
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    
    // Store chunks of audio as they arrive
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = async () => {
      // Merge audio chunks full audio
      const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
      const formData = new FormData();
      formData.append("file", audioBlob, "input.wav");

      // Show spinner before sending
      spinner.style.display = "block";

      // Sends audio to Flask
      const response = await fetch("/upload_audio", {
        method: "POST",
        body: formData
      });
      const data = await response.json();


      // Backend stuff happens


      // Hide spinner after receiving response
      spinner.style.display = "none";

      console.log("Flask Response:", data);

      // Display user + AI text
      chatBox.innerHTML += `<p>User: ${data.transcript}</p>`;
      chatBox.innerHTML += `<p>AI: ${data.ai_response}</p>`;
      chatBox.scrollTop = chatBox.scrollHeight;
    };

    mediaRecorder.start();
    startButton.disabled = true;
    stopButton.disabled = false;
  };

  // Stops the recording
  stopButton.onclick = () => {
    mediaRecorder.stop();
    startButton.disabled = false;
    stopButton.disabled = true;
  };
</script>

{% endblock %}